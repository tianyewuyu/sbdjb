<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二维码登记系统 - 数据管理</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .data-section {
            grid-column: 1 / -1;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid #3498db;
            color: #3498db;
        }
        .btn-danger {
            background: #ff4757;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .alert-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .empty-data {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
        }
        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .stats {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>二维码登记系统 - 数据管理</h1>
        <p>在这里查看和管理所有扫码登记的数据</p>
    </div>

    <div class="alert alert-info">
        <strong>数据存储说明：</strong> 所有数据保存在您当前设备的浏览器存储中。清除浏览器数据会导致记录丢失，请定期导出备份。
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-label">总记录数</div>
            <div class="stat-number" id="totalRecords">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">今日登记</div>
            <div class="stat-number" id="todayRecords">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">设备数量</div>
            <div class="stat-number" id="equipmentCount">0</div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>数据筛选</h2>
            <div class="form-group">
                <label for="search">搜索（姓名/手机/科室）</label>
                <input type="text" id="search" placeholder="输入关键词搜索">
            </div>
            <div class="form-group">
                <label for="dateFilter">按日期筛选</label>
                <input type="date" id="dateFilter">
            </div>
            <div class="form-group">
                <label for="equipmentFilter">按设备筛选</label>
                <select id="equipmentFilter">
                    <option value="">所有设备</option>
                    <option value="跑步机">跑步机</option>
                    <option value="动感单车">动感单车</option>
                    <option value="椭圆机">椭圆机</option>
                    <option value="划船机">划船机</option>
                    <option value="力量训练器">力量训练器</option>
                </select>
            </div>
            <button class="btn" onclick="filterRecords()">应用筛选</button>
            <button class="btn btn-outline" onclick="clearFilters()">清除筛选</button>
        </div>

        <div class="card">
            <h2>数据管理</h2>
            <p>您可以导出数据备份或清空所有数据</p>
            <button class="btn" onclick="exportToCSV()">导出CSV</button>
            <button class="btn btn-outline" onclick="exportToJSON()">导出JSON</button>
            <button class="btn btn-danger" onclick="clearAllData()">清空所有数据</button>
            
            <div style="margin-top: 20px;">
                <h3>导入数据</h3>
                <input type="file" id="importFile" accept=".csv,.json" style="margin-bottom: 10px;">
                <button class="btn btn-outline" onclick="importData()">导入数据</button>
            </div>
        </div>

        <div class="card data-section">
            <h2>登记记录 <span id="recordsCount" style="font-size: 16px; color: #7f8c8d;"></span></h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>姓名</th>
                            <th>手机号码</th>
                            <th>科室/部门</th>
                            <th>使用设备</th>
                            <th>登记时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTable">
                        <tr>
                            <td colspan="7" class="empty-data">正在加载数据...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 初始化数据存储
        function initStorage() {
            if (!localStorage.getItem('registrationRecords')) {
                localStorage.setItem('registrationRecords', JSON.stringify([]));
            }
            
            if (!localStorage.getItem('equipmentList')) {
                const defaultEquipment = [
                    { name: '跑步机', count: 0 },
                    { name: '动感单车', count: 0 },
                    { name: '椭圆机', count: 0 },
                    { name: '划船机', count: 0 },
                    { name: '力量训练器', count: 0 }
                ];
                localStorage.setItem('equipmentList', JSON.stringify(defaultEquipment));
            }
        }
        
        // 加载登记记录
        function loadRecords() {
            const records = JSON.parse(localStorage.getItem('registrationRecords') || '[]');
            const tableBody = document.getElementById('recordsTable');
            
            // 更新记录数量显示
            document.getElementById('recordsCount').textContent = `(共 ${records.length} 条记录)`;
            document.getElementById('totalRecords').textContent = records.length;
            
            if (records.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="empty-data">暂无登记记录</td></tr>';
                return;
            }
            
            let tableHTML = '';
            records.forEach((record, index) => {
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${record.name}</td>
                        <td>${record.phone}</td>
                        <td>${record.department}</td>
                        <td>${record.equipment}</td>
                        <td>${record.date} ${record.time}</td>
                        <td>
                            <button class="btn btn-outline" onclick="deleteRecord(${record.id})" style="padding: 5px 10px; font-size: 12px;">删除</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            
            // 更新今日记录数
            const today = new Date().toLocaleDateString('zh-CN');
            const todayRecords = records.filter(record => record.date === today);
            document.getElementById('todayRecords').textContent = todayRecords.length;
            
            // 更新设备数量
            const equipmentList = JSON.parse(localStorage.getItem('equipmentList') || '[]');
            document.getElementById('equipmentCount').textContent = equipmentList.length;
        }
        
        // 筛选记录
        function filterRecords() {
            const searchValue = document.getElementById('search').value.toLowerCase();
            const dateValue = document.getElementById('dateFilter').value;
            const equipmentValue = document.getElementById('equipmentFilter').value;
            
            let records = JSON.parse(localStorage.getItem('registrationRecords') || '[]');
            
            // 应用筛选条件
            if (searchValue) {
                records = records.filter(record => 
                    record.name.toLowerCase().includes(searchValue) || 
                    record.phone.includes(searchValue) ||
                    record.department.toLowerCase().includes(searchValue)
                );
            }
            
            if (dateValue) {
                const filterDate = new Date(dateValue).toLocaleDateString('zh-CN');
                records = records.filter(record => record.date === filterDate);
            }
            
            if (equipmentValue) {
                records = records.filter(record => record.equipment === equipmentValue);
            }
            
            // 更新表格
            const tableBody = document.getElementById('recordsTable');
            
            // 更新记录数量显示
            document.getElementById('recordsCount').textContent = `(筛选出 ${records.length} 条记录)`;
            
            if (records.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="empty-data">没有找到匹配的记录</td></tr>';
                return;
            }
            
            let tableHTML = '';
            records.forEach((record, index) => {
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${record.name}</td>
                        <td>${record.phone}</td>
                        <td>${record.department}</td>
                        <td>${record.equipment}</td>
                        <td>${record.date} ${record.time}</td>
                        <td>
                            <button class="btn btn-outline" onclick="deleteRecord(${record.id})" style="padding: 5px 10px; font-size: 12px;">删除</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }
        
        // 清除筛选条件
        function clearFilters() {
            document.getElementById('search').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('equipmentFilter').value = '';
            loadRecords();
        }
        
        // 删除单条记录
        function deleteRecord(id) {
            if (!confirm('确定要删除这条记录吗？')) return;
            
            let records = JSON.parse(localStorage.getItem('registrationRecords') || '[]');
            records = records.filter(record => record.id !== id);
            localStorage.setItem('registrationRecords', JSON.stringify(records));
            
            loadRecords();
        }
        
        // 导出CSV文件
        function exportToCSV() {
            const records = JSON.parse(localStorage.getItem('registrationRecords') || '[]');
            
            if (records.length === 0) {
                alert('没有数据可导出');
                return;
            }
            
            // CSV表头
            let csv = '姓名,手机号码,科室/部门,使用设备,登记日期,登记时间\n';
            
            // 添加数据行
            records.forEach(record => {
                csv += `"${record.name}","${record.phone}","${record.department}","${record.equipment}","${record.date}","${record.time}"\n`;
            });
            
            // 创建下载链接
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `登记记录_${new Date().toLocaleDateString('zh-CN')}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 导出JSON文件
        function exportToJSON() {
            const records = JSON.parse(localStorage.getItem('registrationRecords') || '[]');
            
            if (records.length === 0) {
                alert('没有数据可导出');
                return;
            }
            
            const dataStr = JSON.stringify(records, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `登记记录_${new Date().toLocaleDateString('zh-CN')}.json`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 导入数据
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择要导入的文件');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let records;
                    if (file.name.endsWith('.csv')) {
                        // 简单的CSV解析逻辑
                        const csvData = e.target.result;
                        const lines = csvData.split('\n');
                        records = [];
                        
                        // 跳过表头
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            // 简单的CSV解析（注意：这不处理带逗号的引用字段）
                            const values = line.split(',');
                            if (values.length >= 6) {
                                records.push({
                                    id: Date.now() + i,
                                    name: values[0].replace(/"/g, ''),
                                    phone: values[1].replace(/"/g, ''),
                                    department: values[2].replace(/"/g, ''),
                                    equipment: values[3].replace(/"/g, ''),
                                    date: values[4].replace(/"/g, ''),
                                    time: values[5].replace(/"/g, ''),
                                    timestamp: new Date().toISOString()
                                });
                            }
                        }
                    } else if (file.name.endsWith('.json')) {
                        records = JSON.parse(e.target.result);
                    } else {
                        alert('不支持的文件格式');
                        return;
                    }
                    
                    if (records.length > 0) {
                        // 合并现有数据
                        const existingRecords = JSON.parse(localStorage.getItem('registrationRecords') || '[]');
                        const combinedRecords = [...existingRecords, ...records];
                        localStorage.setItem('registrationRecords', JSON.stringify(combinedRecords));
                        
                        alert(`成功导入 ${records.length} 条记录`);
                        loadRecords();
                        fileInput.value = '';
                    } else {
                        alert('文件中没有找到有效数据');
                    }
                } catch (error) {
                    alert('文件解析失败: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }
        
        // 清空所有数据
        function clearAllData() {
            if (!confirm('确定要清空所有数据吗？此操作不可恢复！')) return;
            
            localStorage.setItem('registrationRecords', JSON.stringify([]));
            
            // 重置设备计数
            const equipmentList = JSON.parse(localStorage.getItem('equipmentList') || '[]');
            equipmentList.forEach(equipment => equipment.count = 0);
            localStorage.setItem('equipmentList', JSON.stringify(equipmentList));
            
            loadRecords();
            alert('所有数据已清空！');
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initStorage();
            loadRecords();
            
            // 添加搜索框实时筛选
            document.getElementById('search').addEventListener('input', filterRecords);
            document.getElementById('dateFilter').addEventListener('change', filterRecords);
            document.getElementById('equipmentFilter').addEventListener('change', filterRecords);
        });
    </script>
</body>
</html>